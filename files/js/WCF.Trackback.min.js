WCF.Trackback={},WCF.Trackback.Handler=Class.extend({_objectType:"",_objectID:0,_itemsLoaded:0,_list:null,_lastSeenTime:0,_itemsCount:0,_canDelete:!1,_canBlock:!1,_canViewIPAddresses:!1,_proxy:null,_loadNextButton:null,_dialog:null,init:function(a,b,c,d){this._objectID=b,this._objectType=a,this._itemsLoaded=c,this._lastSeenTime=d,this._proxy=new WCF.Action.Proxy({failure:$.proxy(this._failure,this),success:$.proxy(this._success,this)}),this._list=$('.trackbackList[data-object-id="'+b+'"][data-object-type="'+a+'"]'),this._list.length||console.debug("[WCF.Trackback.Handler] unable to find list"),this._canBlock=this._list.data("canBlock"),this._canDelete=this._list.data("canDelete"),this._canViewIPAddresses=this._list.data("canViewIpAddresses"),this._itemsCount=this._list.data("trackbacks"),this._handleLoadNext(),this._initTrackbacks()},_handleLoadNext:function(){this._itemsLoaded<this._itemsCount?(null===this._loadNextButton&&(this._loadNextButton=$('<li class="trackbackLoadNext"><button class="small">'+WCF.Language.get("wcf.trackback.more")+"</button></li>").appendTo(this._list),this._loadNextButton.children("button").click($.proxy(this._loadItems,this))),this._loadNextButton.enable()):null!==this._loadNextButton&&this._loadNextButton.hide()},_initTrackbacks:function(){var a=this;this._list.find(".jsTrackback").each(function(b,c){var d=$(c).removeClass("jsTrackback");if(a._canBlock){if(d.data("blocked"))var e=$('<li><a href="#" class="jsTooltip" title="'+WCF.Language.get("wcf.trackback.unblock")+'"><span class="icon icon16 fa-undo" /> <span class="invisible">'+WCF.Language.get("wcf.trackback.unblock")+"</span></a></li>");else var e=$('<li><a href="#" class="jsTooltip" title="'+WCF.Language.get("wcf.trackback.block")+'"><span class="icon icon16 fa-ban" /> <span class="invisible">'+WCF.Language.get("wcf.trackback.block")+"</span></a></li>");e.data("trackbackID",d.data("trackbackID")).appendTo(d.find("ul.trackbackOptions:eq(0)")).click(function(b){a._toogleBlock(b)})}a._canViewIPAddresses&&d.data("hasIpAddress")&&$('<li><a href="#" class="jsTooltip" title="IP Adresse"><span class="icon icon16 icon-globe" /> <span class="invisible">IP Adresse</span></a></li>').data("trackbackID",d.data("trackbackID")).appendTo(d.find("ul.trackbackOptions:eq(0)")).click(function(b){a._showIPAddress(b)}),a._canDelete&&$('<li><a href="#" class="jsTooltip" title="'+WCF.Language.get("wcf.global.button.delete")+'"><span class="icon icon16 icon-remove" /> <span class="invisible">'+WCF.Language.get("wcf.global.button.delete")+"</span></a></li>").data("trackbackID",d.data("trackbackID")).appendTo(d.find("ul.trackbackOptions:eq(0)")).click(function(b){a._delete(b)})})},_loadItems:function(){this._loadNextButton.disable(),this._proxy.setOption("data",{actionName:"loadTrackbacks",className:"wcf\\data\\trackback\\TrackbackAction",parameters:{objectType:this._objectType,objectID:this._objectID,lastSeenTime:this._lastSeenTime}}),this._proxy.sendRequest()},_addItems:function(a,b,c){0!==b?(this._itemsLoaded+=b,this._lastSeenTime=c,$(a).appendTo(this._list),this._initTrackbacks(),WCF.System.Event.fireEvent("com.hg-202.trackback","addItems",{self:this})):this._itemsLoaded=this._itemsCount,this._handleLoadNext()},_toogleBlock:function(a){a.preventDefault(),this._proxy.setOption("data",{actionName:"toogleBlock",className:"wcf\\data\\trackback\\TrackbackAction",objectIDs:[$(a.currentTarget).data("trackbackID")]}),this._proxy.sendRequest()},_delete:function(a){a.preventDefault(),WCF.System.Confirmation.show(WCF.Language.get("wcf.trackback.delete.confirmMessage"),$.proxy(function(b){"confirm"===b&&(this._proxy.setOption("data",{actionName:"remove",className:"wcf\\data\\trackback\\TrackbackAction",objectIDs:[$(a.currentTarget).data("trackbackID")]}),this._proxy.sendRequest())},this))},_showIPAddress:function(a){a.preventDefault();var b=$(a.currentTarget).data("ipAddress");null===this._dialog&&(this._dialog=$('<div id="trackbackIPAddressDialog" />').hide().appendTo(document.body)),this._dialog.html(b),this._dialog.wcfDialog({title:"IP-Adresse"}),this._dialog.wcfDialog("render")},_success:function(a){"remove"===a.actionName?a.returnValues.objectIDs.forEach(function(a){$('li.trackback[data-trackback-id="'+a+'"]').remove()}):"toogleBlock"===a.actionName?(a.returnValues.blocked.forEach(function(a){$(this._list).find('li.trackback[data-trackback-id="'+a+'"]').addClass("trackbackBlocked").find(".fa-ban").removeClass("fa-ban").addClass("fa-undo")}),a.returnValues.unblocked.forEach(function(a){$(this._list).find('li.trackback[data-trackback-id="'+a+'"]').removeClass("trackbackBlocked").find(".fa-undo").removeClass("fa-undo").addClass("fa-ban")})):"loadTrackbacks"===a.actionName&&this._addItems(a.returnValues.template,a.returnValues.count,a.returnValues.lastSeenTime)},_failure:function(){console.debug("request failed")}});